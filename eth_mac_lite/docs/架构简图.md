# 以太网 MAC Lite - 简化架构图

## 整体架构 (简化版)

```
╔════════════════════════════════════════════════════════════════╗
║              以太网 MAC Lite 架构                               ║
║              (无 IP/ARP 协议栈)                                 ║
╚════════════════════════════════════════════════════════════════╝

外部世界                                                系统内存
   │                                                       ▲
   │ 以太网帧                                              │
   ▼                                                       │
┌─────────────────────────────────────────────────────────────┐
│ 步骤1: RGMII 物理接口                                        │
│ ┌────────┐                                                  │
│ │ RGMII  │  接收4-bit DDR → 8-bit SDR                      │
│ │  PHY   │  125MHz时钟，支持1Gbps                          │
│ └────────┘                                                  │
└─────────────────────────────────────────────────────────────┘
   │ 8-bit AXI-Stream
   ▼
┌─────────────────────────────────────────────────────────────┐
│ 步骤2: MAC 1G + FIFO                                         │
│ ┌────────┐                                                  │
│ │  MAC   │  - 前导码/SFD检测                               │
│ │  Core  │  - FCS校验                                      │
│ │        │  - 去除以太网帧头尾                              │
│ │ FIFO   │  - 4KB缓冲 (跨时钟域)                           │
│ └────────┘                                                  │
└─────────────────────────────────────────────────────────────┘
   │ 8-bit AXI-Stream (logic_clk域)
   ▼
┌─────────────────────────────────────────────────────────────┐
│ 步骤3: 帧过滤器                                              │
│ ┌────────┐                                                  │
│ │ Frame  │  - 提取目的MAC (前6字节)                        │
│ │ Filter │  - 与本地MAC比较                                │
│ │        │  - 检查广播/组播                                │
│ │        │  - 混杂模式支持                                 │
│ └────────┘                                                  │
│ 通过 → 继续  |  拒绝 → 丢弃                                 │
└─────────────────────────────────────────────────────────────┘
   │ 8-bit AXI-Stream (已过滤)
   ▼
┌─────────────────────────────────────────────────────────────┐
│ 步骤4: 位宽转换 (RX)                                         │
│ ┌────────┐                                                  │
│ │  AXIS  │  8-bit  →  64-bit                               │
│ │Adapter │  逐字节累积，8字节后输出                         │
│ └────────┘                                                  │
└─────────────────────────────────────────────────────────────┘
   │ 64-bit AXI-Stream
   ▼
┌─────────────────────────────────────────────────────────────┐
│ 步骤5: DMA 写入                                              │
│ ┌────────┐                                                  │
│ │  DMA   │  - 读取RX描述符                                 │
│ │ Write  │  - AXI写突发传输                                │
│ │        │  - 更新状态                                     │
│ └────────┘  - 触发中断                                     │
└─────────────────────────────────────────────────────────────┘
   │ AXI Master 写通道
   └─────────────────────────────────────────────────────────▶ 内存


发送路径 (TX):
═════════════

系统内存                                                外部世界
   │                                                       ▲
   │                                                       │
   ▼                                                       │
┌─────────────────────────────────────────────────────────────┐
│ 步骤1: DMA 读取                                              │
│ ┌────────┐                                                  │
│ │  DMA   │  - 读取TX描述符                                 │
│ │  Read  │  - AXI读突发传输                                │
│ │        │  - 生成64-bit流                                 │
│ └────────┘  - 更新状态                                     │
└─────────────────────────────────────────────────────────────┘
   │ 64-bit AXI-Stream
   ▼
┌─────────────────────────────────────────────────────────────┐
│ 步骤2: 位宽转换 (TX)                                         │
│ ┌────────┐                                                  │
│ │  AXIS  │  64-bit  →  8-bit                               │
│ │Adapter │  每周期输出8字节中的1字节                        │
│ └────────┘                                                  │
└─────────────────────────────────────────────────────────────┘
   │ 8-bit AXI-Stream
   ▼
┌─────────────────────────────────────────────────────────────┐
│ 步骤3: MAC 1G + FIFO                                         │
│ ┌────────┐                                                  │
│ │  MAC   │  - 添加前导码/SFD                               │
│ │  Core  │  - 计算并添加FCS                                │
│ │        │  - 帧填充 (如<64字节)                           │
│ │ FIFO   │  - 4KB缓冲 (跨时钟域)                           │
│ └────────┘                                                  │
└─────────────────────────────────────────────────────────────┘
   │ 8-bit SDR
   ▼
┌─────────────────────────────────────────────────────────────┐
│ 步骤4: RGMII 物理接口                                        │
│ ┌────────┐                                                  │
│ │ RGMII  │  发送8-bit SDR → 4-bit DDR                      │
│ │  PHY   │  125MHz时钟输出                                 │
│ └────────┘                                                  │
└─────────────────────────────────────────────────────────────┘
   │ RGMII信号
   └─────────────────────────────────────────────────────────▶ PHY


控制平面:
════════

CPU / 软件
   │
   │ AXI-Lite 总线
   ▼
┌─────────────────────────────────────────────────────────────┐
│ AXI-Lite 控制寄存器 (16个寄存器)                             │
│ ┌────────────────────────────────────────────────────────┐ │
│ │ 0x00: 控制 (TX/RX使能, DMA使能)                        │ │
│ │ 0x04: 状态 (链路速度, 错误状态)                        │ │
│ │ 0x08: MAC地址                                          │ │
│ │ 0x10: 过滤器配置                                       │ │
│ │ 0x14: 中断使能                                         │ │
│ │ 0x18: 中断状态                                         │ │
│ │ 0x20: RX描述符 (地址/长度/Tag/控制)                   │ │
│ │ 0x30: TX描述符 (地址/长度/Tag/控制)                   │ │
│ └────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
   │       │       │       │
   ▼       ▼       ▼       ▼
 [MAC]  [Filter] [DMA]  [IRQ]
```

## 数据格式

### 接收的以太网帧 (原始)

```
┌──────────────────────────────────────────────────────────┐
│ 以太网帧结构 (Lite版直接传递)                            │
└──────────────────────────────────────────────────────────┘

MAC层接收:
┌─────┬─────┬─────┬─────┬──────────┬─────┐
│前导 │ SFD │Dest │ Src │EtherType │     │
│7字节│1字节│6字节│6字节│  2字节   │     │
└─────┴─────┴─────┴─────┴──────────┴─────┘
           │                        │
           │     Payload (46-1500)  │
           │                        │
           └────────────────────────┘
                      │
                  ┌───▼───┐
                  │  FCS  │ 4字节
                  └───────┘

传递给软件 (DMA后):
┌─────┬─────┬──────────┬─────────────┐
│Dest │ Src │EtherType │   Payload   │
│6字节│6字节│  2字节   │  46-1500    │
└─────┴─────┴──────────┴─────────────┘
  ▲                                  ▲
  │                                  │
  └──────────这些需要软件处理─────────┘
```

### 发送的以太网帧

```
软件准备 (DMA前):
┌─────┬─────┬──────────┬─────────────┐
│Dest │ Src │EtherType │   Payload   │
│6字节│6字节│  2字节   │  46-1500    │
└─────┴─────┴──────────┴─────────────┘
  ▲                                  ▲
  │                                  │
  └──────软件必须准备完整帧头────────┘

MAC自动添加:
┌─────┬─────┬─────────────────────┬─────┐
│前导 │ SFD │   [软件准备的数据]   │ FCS │
│7字节│1字节│                     │4字节│
└─────┴─────┴─────────────────────┴─────┘
```

## 与完整版的关键区别

```
┌──────────────────────────────────────────────────────────┐
│ 完整版数据流                                              │
└──────────────────────────────────────────────────────────┘

RGMII → MAC → Filter → Eth Parse → IP/ARP → DMA → 内存
  ▲                        │           │
  │                        ▼           ▼
  │                    解析头部    ARP查询/应答
  │                    提取payload  MAC解析
  │                        │           │
  └────────────────────────┴───────────┘
              软件只处理IP payload


┌──────────────────────────────────────────────────────────┐
│ Lite版数据流                                              │
└──────────────────────────────────────────────────────────┘

RGMII → MAC → Filter → Width → DMA → 内存
  ▲                      Conv
  │
  └────────────────────────────────────────────────
            软件处理完整以太网帧（从目的MAC开始）
```

## 时钟域

```
┌──────────────────────────────────────────────────────────┐
│ 时钟域设计                                                │
└──────────────────────────────────────────────────────────┘

gtx_clk (125MHz)
├─ RGMII TX物理接口
├─ RGMII RX物理接口
└─ MAC核心逻辑

gtx_clk90 (125MHz, 90°相移)
└─ RGMII TX DDR输出 (可选)

logic_clk (50-125MHz, 可配置)
├─ MAC FIFO输出
├─ 帧过滤器
├─ 位宽转换
├─ DMA引擎
├─ AXI Master
└─ AXI-Lite Slave

跨时钟域同步:
┌────────────┐              ┌────────────┐
│  gtx_clk   │──异步FIFO──▶│ logic_clk  │
│ (MAC核心)  │              │(系统总线)  │
└────────────┘              └────────────┘
```

## 中断系统

```
┌──────────────────────────────────────────────────────────┐
│ 中断生成和处理                                            │
└──────────────────────────────────────────────────────────┘

事件源                 中断寄存器          CPU
────────              ──────────         ────

RX完成 ──┐
         ├──▶ irq_rx_done  ──┐
TX完成 ──┘                   │
                             ├──▶ AND ──▶ IRQ引脚
RX错误 ──┐                   │      ▲
         ├──▶ irq_rx_error ──┤      │
TX错误 ──┘                   │  irq_enable
                             │
                             └─────────────────┐
                                              │
                                              ▼
                           中断状态寄存器(0x18)
                              (写1清除)
```

## 软件接口示例

```c
// 1. 初始化
void eth_mac_lite_init(void) {
    // 设置MAC地址
    write_reg(MAC_ADDR_LO, 0xAABBCCDD);
    write_reg(MAC_ADDR_HI, 0x0000EEFF);
    
    // 配置过滤器
    write_reg(FILTER_CFG, FILTER_EN | BROADCAST_EN);
    
    // 使能中断
    write_reg(IRQ_ENABLE, IRQ_RX_DONE | IRQ_TX_DONE);
    
    // 使能MAC
    write_reg(CTRL, TX_EN | RX_EN | DMA_TX_EN | DMA_RX_EN);
}

// 2. 发送帧 (需要完整构建以太网头)
void send_frame(uint8_t *dest_mac, uint16_t ethertype, 
                uint8_t *data, uint16_t len) {
    // 在缓冲区构建完整帧
    uint8_t *frame = alloc_buffer(14 + len);
    
    // 目的MAC (6字节)
    memcpy(frame, dest_mac, 6);
    
    // 源MAC (6字节) - 从寄存器读取或硬编码
    memcpy(frame + 6, local_mac, 6);
    
    // EtherType (2字节)
    frame[12] = ethertype >> 8;
    frame[13] = ethertype & 0xFF;
    
    // Payload
    memcpy(frame + 14, data, len);
    
    // 配置DMA
    write_reg(TX_DESC_ADDR, (uint32_t)frame);
    write_reg(TX_DESC_LEN, 14 + len);
    write_reg(TX_DESC_TAG, 0x01);
    write_reg(TX_DESC_CTRL, DESC_VALID);  // 启动
}

// 3. 接收帧 (直接获得原始帧)
void receive_frame(void) {
    // 配置接收缓冲区
    write_reg(RX_DESC_ADDR, (uint32_t)rx_buffer);
    write_reg(RX_DESC_LEN, 1518);  // 最大帧
    write_reg(RX_DESC_TAG, 0x01);
    write_reg(RX_DESC_CTRL, DESC_VALID);  // 启动
    
    // 等待中断...
    // 接收到的数据从目的MAC开始
    uint8_t *dest_mac = rx_buffer;       // 偏移0
    uint8_t *src_mac = rx_buffer + 6;    // 偏移6
    uint16_t ethertype = (rx_buffer[12] << 8) | rx_buffer[13];
    uint8_t *payload = rx_buffer + 14;   // 偏移14
    
    // 解析和处理...
}
```

---

**版本**: v1.0  
**日期**: 2025年10月7日  
**说明**: 这是简化的架构图，突出与完整版的区别

